FROM condaforge/miniforge3:25.3.1-0

RUN set -x \
    # basic dependencies
    apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/3bf863cc.pub && \
    apt-get update && apt-get upgrade -y && \
    apt-get install automake autoconf libtool -y

RUN mkdir ws

COPY pyhwloc_ext_dev.yml ws/pyhwloc_dev.yml

RUN mamba env update -n base -f ws/pyhwloc_dev.yml -v && mamba clean --all --yes

RUN \
    cd /ws && \
    git clone https://github.com/doxygen/doxygen.git && \
    cd doxygen && git checkout d49be63057d71f487312f43339516bc92cc685fa && cd -

RUN \
    cd /ws/ && \
    git clone https://github.com/open-mpi/hwloc.git && \
    cd hwloc && git checkout 1098578d77d9cec7b8154479ecb7aa9f7d483950 && cd -

SHELL ["mamba", "run", "--no-capture-output", "-n", "base", "/bin/bash", "-c"]

COPY install_doxygen.sh ws/install_doxygen.sh

COPY install_hwloc.sh ws/install_hwloc.sh

RUN \
    cd /ws/ && \
    echo "con: CONDA_ENV ${CONDA_PREFIX}" && \
    ./install_doxygen.sh

RUN \
    cd /ws/ && \
    ./install_hwloc.sh
